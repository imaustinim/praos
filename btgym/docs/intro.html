

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Package Description &mdash; BTGym 0.0.7 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="BTGym 0.0.7 documentation" href="index.html"/>
        <link rel="next" title="btgym.envs package" href="btgym.envs.html"/>
        <link rel="prev" title="BTGym DOCs" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> BTGym
          

          
          </a>

          
            
            
              <div class="version">
                0.0.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Package Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="#quickstart">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="#problem-definition">Problem definition</a></li>
<li class="toctree-l1"><a class="reference internal" href="#environment-engine-description">Environment engine description</a></li>
<li class="toctree-l1"><a class="reference internal" href="#data-flow-structure">Data flow structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="#a3c-framework-description">A3C framework description</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="btgym.envs.html">btgym.envs package</a></li>
<li class="toctree-l1"><a class="reference internal" href="btgym.html">btgym.dataserver module</a></li>
<li class="toctree-l1"><a class="reference internal" href="btgym.html#module-btgym.server">btgym.server module</a></li>
<li class="toctree-l1"><a class="reference internal" href="btgym.html#module-btgym.spaces">btgym.spaces module</a></li>
<li class="toctree-l1"><a class="reference internal" href="btgym.strategy.html">btgym.strategy package</a></li>
<li class="toctree-l1"><a class="reference internal" href="btgym.monitor.html">btgym.monitor package</a></li>
<li class="toctree-l1"><a class="reference internal" href="btgym.rendering.html">btgym.rendering package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="btgym.datafeed.html">btgym.datafeed package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="btgym.algorithms.html">btgym.algorithms package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="btgym.research.html">btgym.research package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BTGym</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Package Description</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/intro.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="package-description">
<h1>Package Description<a class="headerlink" href="#package-description" title="Permalink to this headline">¶</a></h1>
<p><strong>Btgym</strong> is an OpenAI Gym-compatible environment for Backtrader backtesting/trading library,
designed to provide gym-integrated framework for
running reinforcement learning experiments
in [close to] real world algorithmic trading environments.</p>
<p><strong>[experimental]:</strong>
Besides core environment package includes implementations of several deep RL algorithms,
tuned [to attempt] to solve this particular type of tasks.</p>
<p><strong>Backtrader</strong> is open-source algorithmic trading library:
GitHub: <a class="reference external" href="http://github.com/mementum/backtrader">http://github.com/mementum/backtrader</a>
Documentation and community:
<a class="reference external" href="http://www.backtrader.com/">http://www.backtrader.com/</a></p>
<p><strong>OpenAI Gym</strong> is…,
well, everyone knows Gym:
GitHub: <a class="reference external" href="http://github.com/openai/gym">http://github.com/openai/gym</a>
Documentation and community:
<a class="reference external" href="https://gym.openai.com/">https://gym.openai.com/</a></p>
<p><strong>DISCLAIMER:</strong>
This package is neither out-of-the-box-moneymaker, nor it provides ready-to-converge RL solutions.
Rather, it is framework for setting experiments with complex, non stationary, time-series based environments.
I have no idea what kind of algorithm and setup will solve it [if any]. Explore on your own!</p>
</div>
<div class="section" id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<p>It is highly recommended to run BTGym in designated virtual environment.</p>
<p>Clone or copy btgym repository to local disk, cd to it and run: <cite>pip install -e .</cite> to install package and all dependencies:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">Kismuz</span><span class="o">/</span><span class="n">btgym</span><span class="o">.</span><span class="n">git</span>

<span class="n">cd</span> <span class="n">btgym</span>

<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">e</span> <span class="o">.</span>
</pre></div>
</div>
<p>To update to latest version:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">btgym</span>

<span class="n">git</span> <span class="n">pull</span>

<span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">upgrade</span> <span class="o">-</span><span class="n">e</span> <span class="o">.</span>
</pre></div>
</div>
<dl class="docutils">
<dt>Note:</dt>
<dd><p class="first">BTGym requres Matplotlib version 2.0.2, downgrade your installation if you have version 2.1:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">matplotlib</span><span class="o">==</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">2</span>
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="quickstart">
<h1>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h1>
<p>Making gym environment with all parmeters set to defaults is as simple as:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">btgym</span> <span class="k">import</span> <span class="n">BTgymEnv</span>

<span class="n">MyEnvironment</span> <span class="o">=</span> <span class="n">BTgymEnv</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../examples/data/DAT_ASCII_EURUSD_M1_2016.csv&#39;</span><span class="p">,)</span>
</pre></div>
</div>
<p>Adding more controls may look like:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">btgym</span> <span class="k">import</span> <span class="n">BTgymEnv</span>
<span class="kn">from</span> <span class="nn">gym</span> <span class="k">import</span> <span class="n">spaces</span>

<span class="n">MyEnvironment</span> <span class="o">=</span> <span class="n">BTgymEnv</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../examples/data/DAT_ASCII_EURUSD_M1_2016.csv&#39;</span><span class="p">,</span>
                         <span class="n">episode_duration</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;hours&#39;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span> <span class="s1">&#39;minutes&#39;</span><span class="p">:</span> <span class="mi">55</span><span class="p">},</span>
                         <span class="n">drawdown_call</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                         <span class="n">state_shape</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">4</span><span class="p">))},</span>
                         <span class="n">port</span><span class="o">=</span><span class="mi">5555</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="p">)</span>
</pre></div>
</div>
<p>Same one but registering environment in Gym preferred way:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gym</span>
<span class="kn">from</span> <span class="nn">gym</span> <span class="k">import</span> <span class="n">spaces</span>
<span class="kn">from</span> <span class="nn">btgym</span> <span class="k">import</span> <span class="n">BTgymEnv</span>

<span class="n">env_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../examples/data/DAT_ASCII_EURUSD_M1_2016.csv&#39;</span><span class="p">,</span>
                  <span class="n">episode_duration</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;hours&#39;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span> <span class="s1">&#39;minutes&#39;</span><span class="p">:</span> <span class="mi">55</span><span class="p">},</span>
                  <span class="n">drawdown_call</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                  <span class="n">state_shape</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">4</span><span class="p">))},</span>
                  <span class="n">port</span><span class="o">=</span><span class="mi">5555</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="p">)</span>

<span class="n">gym</span><span class="o">.</span><span class="n">envs</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;backtrader-v5555&#39;</span><span class="p">,</span> <span class="n">entry_point</span><span class="o">=</span><span class="s1">&#39;btgym:BTgymEnv&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">env_params</span><span class="p">,)</span>

<span class="n">MyEnvironment</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s1">&#39;backtrader-v5555&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Maximum environment flexibility is achieved by explicitly defining and passing <cite>Dataset</cite> and <cite>Cerebro</cite> instances:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">gym</span> <span class="k">import</span> <span class="n">spaces</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="k">as</span> <span class="nn">bt</span>
<span class="kn">from</span> <span class="nn">btgym</span> <span class="k">import</span> <span class="n">BTgymDataset</span><span class="p">,</span> <span class="n">BTgymBaseStrategy</span><span class="p">,</span> <span class="n">BTgymEnv</span>

<span class="n">MyCerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>
<span class="n">MyCerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">BTgymStrategy</span><span class="p">,</span>
                      <span class="n">state_shape</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">4</span><span class="p">))},</span>
                      <span class="n">skip_frame</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                      <span class="n">state_low</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">state_high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">drawdown_call</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                      <span class="p">)</span>

<span class="n">MyCerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcash</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span>
<span class="n">MyCerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">setcommission</span><span class="p">(</span><span class="n">commission</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
<span class="n">MyCerebro</span><span class="o">.</span><span class="n">addsizer</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">sizers</span><span class="o">.</span><span class="n">SizerFix</span><span class="p">,</span> <span class="n">stake</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">MyCerebro</span><span class="o">.</span><span class="n">addanalyzer</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">analyzers</span><span class="o">.</span><span class="n">DrawDown</span><span class="p">)</span>

<span class="n">MyDataset</span> <span class="o">=</span> <span class="n">BTgymDataset</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../examples/data/DAT_ASCII_EURUSD_M1_2016.csv&#39;</span><span class="p">,</span>
                         <span class="n">start_weekdays</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                         <span class="n">start_00</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">episode_duration</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;days&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;hours&#39;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span> <span class="s1">&#39;minutes&#39;</span><span class="p">:</span> <span class="mi">55</span><span class="p">},</span>
                         <span class="n">time_gap</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;hours&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                         <span class="p">)</span>

<span class="n">MyEnvironment</span> <span class="o">=</span> <span class="n">BTgymEnv</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">MyDataset</span><span class="p">,</span>
                         <span class="n">engine</span><span class="o">=</span><span class="n">MyCerebro</span><span class="p">,</span>
                         <span class="n">port</span><span class="o">=</span><span class="mi">5555</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="problem-definition">
<h1>Problem definition<a class="headerlink" href="#problem-definition" title="Permalink to this headline">¶</a></h1>
<ul>
<li><dl class="first docutils">
<dt><strong>Discrete actions setup:</strong></dt>
<dd><p class="first">consider setup with one riskless asset acting as broker account cash and K (by default - one) risky assets.
For every risky asset there exists track of historic price records referred as <cite>data-line</cite>.
Apart from assets data lines there [optionally] exists number of exogenous data lines holding some
information and statistics, e.g. economic indexes, encoded news, macroeconomic indicators, weather forecasts
etc. which are considered relevant to decision-making.
It is supposed for this setup that:</p>
<blockquote class="last">
<div><ol class="arabic simple">
<li>there is no interest rates for any asset;</li>
<li>broker actions are fixed-size market orders (<cite>buy</cite>, <cite>sell</cite>, <cite>close</cite>); short selling is permitted;</li>
<li>transaction costs are modelled via broker commission;</li>
</ol>
<p>4. ‘market liquidity’ and ‘capital impact’ assumptions are met;
6. time indexes match for all data lines provided;</p>
</div></blockquote>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>The problem is modelled as discrete-time finite-horizon partially observable Markov decision process for equity/currency trading:</dt>
<dd><ul class="first last simple">
<li><em>for every asset</em> traded agent action space is discrete <cite>(0: `hold</cite> [do nothing], 1:<cite>buy</cite>, 2: <cite>sell</cite>, 3:<cite>close</cite> [position])`;</li>
<li>environment is episodic: maximum  episode duration and episode termination conditions
are set;</li>
<li>for every timestep of the episode agent is given environment state observation as tensor of last
<cite>m</cite> time-embedded preprocessed values for every data-line included and emits actions according some stochastic policy.</li>
<li>agent’s goal is to maximize expected cumulative capital by learning optimal policy;</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><strong>Continuous actions setup[BETA]:</strong></dt>
<dd><p class="first">this setup closely relates to continuous portfolio optimisation problem definition;
it differs from setup above in:</p>
<blockquote>
<div><ol class="arabic simple">
<li>base broker actions are real numbers: <cite>a[i] in [0,1], 0&lt;=i&lt;=K, SUM{a[i]} = 1</cite>  for <cite>K</cite> risky assets added;
each action is a market target order to adjust portfolio to get share <cite>a[i]*100%</cite> for <cite>i</cite>-th  asset;</li>
<li>entire single-step broker action is dictionary of form:
<cite>{cash_name: a[0], asset_name_1: a[1], …, asset_name_K: a[K]}</cite>;</li>
<li>short selling is not permitted;</li>
</ol>
</div></blockquote>
<ul class="last simple">
<li>For RL model it implies having continuous action space as <cite>K+1</cite> dim vector.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="environment-engine-description">
<h1>Environment engine description<a class="headerlink" href="#environment-engine-description" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><dl class="docutils">
<dt>BTgym uses Backtrader framework for actual environment computations, for extensive documentation see:</dt>
<dd><a class="reference external" href="https://www.backtrader.com/docu/index.html">https://www.backtrader.com/docu/index.html</a>.</dd>
</dl>
</div></blockquote>
<p>In short:</p>
<ul class="simple">
<li>User defines backtrading engine parameters by composing <cite>Backtrader.Cerebro()</cite> subclass,
provides historic prices dataset as <cite>BTgymDataset()</cite> instance and passes it as arguments when making BTgym environment.
See <a class="reference external" href="https://www.backtrader.com/docu/concepts.html">https://www.backtrader.com/docu/concepts.html</a> for general Backtrader concepts descriptions.</li>
<li>Environment starts separate server process responsible for rendering gym environment
queries like <cite>env.reset()</cite> and <cite>env.step()</cite> by repeatedly sampling episodes form given dataset and running
backtesting <cite>Cerebro</cite> engine on it. See OpenAI Gym documentation for details: <a class="reference external" href="https://gym.openai.com/docs">https://gym.openai.com/docs</a></li>
</ul>
<hr class="docutils" />
<a class="reference internal image-reference" href="_images/btgym_env_operation.png"><img alt="btgym environment operation" src="_images/btgym_env_operation.png" style="width: 540.6px; height: 764.4px;" /></a>
<p><strong>Workflow sample</strong>:</p>
<ol class="arabic simple">
<li><dl class="first docutils">
<dt>Define backtesting <cite>BTgymStrategy(bt.Strategy)</cite>, which will control Environment inner dynamics and backtesting logic.</dt>
<dd><ul class="first last">
<li>For RL-specific part, any <cite>STATE</cite>, <cite>REWARD</cite>, <cite>DONE</cite> and <cite>INFO</cite> computation logic can be implemented
by overriding <cite>get_state()</cite>, <cite>get_reward()</cite>, <cite>get_info()</cite>, <cite>is_done()</cite> and <cite>set_datalines()</cite> methods.</li>
<li>For Broker/Trading specific part, custom order execution logic, stake sizing,
analytics tracking can be implemented as for regular <cite>bt.Strategy()</cite>.</li>
</ul>
</dd>
</dl>
</li>
<li>Instantiate <cite>Cerbro()</cite>, add <cite>BTgymStrategy()</cite>, backtrader <cite>Sizers</cite>, <cite>Analyzers</cite> and <cite>Observers</cite> (if needed).</li>
<li><dl class="first docutils">
<dt>Define dataset by passing CSV datafile and parameters to BTgymDataset instance.</dt>
<dd><ul class="first last">
<li><cite>BTgymDataset()</cite> is simply <cite>Backtrader.feeds</cite> class wrapper,
which pipes <cite>CSV`[source]-&gt;`pandas`[for efficient sampling]-&gt;`bt.feeds</cite> routine
and implements random episode data sampling.</li>
</ul>
</dd>
</dl>
</li>
<li>Initialize (or register and <cite>make()</cite>) gym environment with <cite>Cerebro()</cite> and <cite>BTgymDataset()</cite> along with other kwargs.</li>
<li><dl class="first docutils">
<dt>Run your favorite RL algorithm:</dt>
<dd><ul class="first last">
<li>start episode by calling <cite>env.reset()</cite>;</li>
<li>advance one step of episode by calling <cite>env.step()</cite>, perform agent training or testing;</li>
<li>after single episode is finished, retrieve agent performance statistic by <cite>env.get_stat()</cite>.</li>
</ul>
</dd>
</dl>
</li>
</ol>
<hr class="docutils" />
<p><strong>Server operation details:</strong></p>
<p>Backtrader server starts when <cite>env.reset()</cite> method is called for first time, runs as separate process, follows
simple Request/Reply pattern (every request should be paired with reply message) and operates one of two modes:</p>
<blockquote>
<div><ul>
<li><p class="first">Control mode: initial mode, accepts only <cite>_reset</cite>, <cite>_stop</cite> and <cite>_getstat</cite> messages. Any other message is ignored
and replied with simple info messge. Shuts down upon recieving <cite>_stop</cite> via <cite>env._stop_server()</cite> method,
goes to episode mode upon <cite>_reset</cite> (via <cite>env.reset()</cite>) and send last run episode statistic (if any) upon <cite>_getstat</cite>
via <cite>env.get_stat()</cite>.</p>
</li>
<li><p class="first">Episode mode: runs episode according <cite>BtGymStrategy()</cite> logic. Accepts <cite>action</cite> messages,
returns <cite>tuple</cite>: <cite>([state observation], [reward], [is_done], [aux.info])</cite>.
Finishes episode upon recieving <cite>action`==`_done</cite> or according to strategy termination rules, than falls
back to control mode.</p>
<blockquote>
<div><ul class="simple">
<li><dl class="first docutils">
<dt>Before every episode start, BTserver samples episode data and adds it to <cite>bt.Cerebro()</cite> instance</dt>
<dd><dl class="first last docutils">
<dt>along with specific <cite>_BTgymAnalyzer</cite>. The service of this hidden Analyzer is twofold:</dt>
<dd><ul class="first last">
<li><dl class="first docutils">
<dt>enables strategy-environment communication by calling RL-related <cite>BTgymStrategy</cite> methods:</dt>
<dd><cite>get_state()</cite>, <cite>get_reward()</cite>, <cite>get_info()</cite> and <cite>is_done()</cite> [see below];</dd>
</dl>
</li>
<li>controls episode termination conditions.</li>
</ul>
</dd>
</dl>
</dd>
</dl>
</li>
<li>Episode runtime: after preparing environment initial state by running <cite>BTgymStrategy</cite> <cite>start()</cite>, <cite>prenext()</cite>
methods, server halts and waits for incoming agent <cite>action</cite>. Upon receiving <cite>action</cite>, server performs all
necessary <cite>next()</cite> computations (e.g. issues orders, computes broker values etc.), composes environment
response and sends it back to agent ( via <cite>_BTgymAnalyzer</cite>). Actually, since ‘no market impact’ is assumed,
all state computations are performed one step ahead:</li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<hr class="docutils" />
<p><strong>Server loop</strong>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">pseudocode</span>
<span class="n">Initialize</span> <span class="n">by</span> <span class="n">receiving</span> <span class="n">engine</span> <span class="p">[</span><span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()]</span> <span class="ow">and</span> <span class="n">dataset</span> <span class="p">[</span><span class="n">BTgymDataset</span><span class="p">()]</span>
<span class="n">Repeat</span> <span class="n">until</span> <span class="n">received</span> <span class="n">message</span> <span class="s1">&#39;_stop&#39;</span><span class="p">:</span>
    <span class="n">Wait</span> <span class="k">for</span> <span class="n">incoming</span> <span class="n">message</span>
    <span class="n">If</span> <span class="n">message</span> <span class="ow">is</span> <span class="s1">&#39;_getstat&#39;</span><span class="p">:</span>
        <span class="n">send</span> <span class="n">episode</span> <span class="n">statistics</span>
    <span class="n">If</span> <span class="n">message</span> <span class="ow">is</span> <span class="s1">&#39;_reset&#39;</span><span class="p">:</span>
        <span class="n">Randomly</span> <span class="n">sample</span> <span class="n">episode</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">BTgymDataset</span>
        <span class="n">Add</span> <span class="n">episode</span> <span class="n">data</span> <span class="n">to</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>
        <span class="n">Add</span> <span class="n">service</span> <span class="n">_BTgymAnalyzer</span><span class="p">()</span> <span class="n">to</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>
        <span class="n">Add</span> <span class="n">DrawDown</span> <span class="n">observer</span> <span class="n">to</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">(),</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">already</span> <span class="n">present</span>
        <span class="n">Prepare</span> <span class="n">BTgymStrategy</span> <span class="n">initial</span> <span class="n">state</span>
        <span class="n">Set</span> <span class="n">agent</span> <span class="o">&lt;</span><span class="n">action</span><span class="o">&gt;</span> <span class="n">to</span> <span class="s1">&#39;hold&#39;</span>
        <span class="n">Repeat</span> <span class="n">until</span> <span class="n">episode</span> <span class="n">termination</span> <span class="n">conditions</span> <span class="n">are</span> <span class="n">met</span><span class="p">:</span>
            <span class="n">Issue</span> <span class="ow">and</span> <span class="n">process</span> <span class="n">orders</span> <span class="n">according</span> <span class="n">to</span> <span class="n">recieved</span> <span class="n">agent</span> <span class="n">action</span>
            <span class="n">Perform</span> <span class="nb">all</span> <span class="n">backtesting</span> <span class="n">engine</span> <span class="n">computations</span>
            <span class="n">Estimate</span> <span class="n">state</span> <span class="n">observation</span>
            <span class="n">Eestimate</span> <span class="n">env</span><span class="o">.</span> <span class="n">reward</span>
            <span class="n">Compose</span> <span class="n">aux</span><span class="o">.</span> <span class="n">information</span>
            <span class="n">Check</span> <span class="n">episode</span> <span class="n">termination</span> <span class="n">conditions</span>
            <span class="n">Wait</span> <span class="k">for</span> <span class="n">incoming</span> <span class="o">&lt;</span><span class="n">action</span><span class="o">&gt;</span> <span class="n">message</span>
            <span class="n">Send</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span> <span class="n">response</span>
</pre></div>
</div>
</div>
<div class="section" id="data-flow-structure">
<h1>Data flow structure<a class="headerlink" href="#data-flow-structure" title="Permalink to this headline">¶</a></h1>
<a class="reference internal image-reference" href="_images/data_domain_iteration.png"><img alt="Btgym Data Domain Structure" src="_images/data_domain_iteration.png" style="width: 637.0px; height: 450.5px;" /></a>
</div>
<div class="section" id="a3c-framework-description">
<h1>A3C framework description<a class="headerlink" href="#a3c-framework-description" title="Permalink to this headline">¶</a></h1>
<p>BTGym can be thougt as two-part package:
one is environment itself and the other one is collection RL algoritms tuned for solving algo-trading tasks.
Below is BTgym A3C training framework operation diagram.
Three advantage actor-critic style algorithms are implemented: A3C itself, it’s UNREAL extension and PPO.</p>
<p>Note that while base training framework is itself is somewhat stable,
exact algorithms implementations and corresponding BTgym startegies, state and reward shaping methods,
data providers etc. are subject to experiments and changes.</p>
<a class="reference internal image-reference" href="_images/btgym_a3c_framework.png"><img alt="A3C framework workwlow image" src="_images/btgym_a3c_framework.png" style="width: 540.6px; height: 764.4px;" /></a>
<hr class="docutils" />
<p><strong>Stacked LSTM Agent</strong></p>
<p>Based on NAV_A3C agent from <a class="reference external" href="https://arxiv.org/pdf/1611.03673.pdf">LEARNING TO NAVIGATE IN COMPLEX ENVIRONMENTS</a>
paper by Mirowski at al.</p>
<p>Modifications to original paper architecture:</p>
<ul class="simple">
<li>splitted Policy/Value outputs: Policy is taken off first LSTM layer, Value - off the second;</li>
<li>LSTM state initialisation: first RNN layer context (policy) is initialised on every episode start, while second
(Value) is reset either on begining of every Trial (future work) or or every N-constant episodes,
motivated by RL^2 approach by Duan et al.,
<a class="reference external" href="https://arxiv.org/pdf/1611.02779.pdf">FAST REINFORCEMENT LEARNING VIA SLOW REINFORCEMENT LEARNING</a>;</li>
<li>inner/external observation state state split: external (market) is encoded via conolution layers and fed to
first LSTM layer, inner (broker) state is fed into second LSTM layer, can optionally be encoded via separate
convolution block (doesnt seem to improve much though);</li>
<li>optional Value Replay losss (<cite>Unreal</cite> feature) improves sample efficiency, but is computationally more expensive;</li>
</ul>
<p>Other details:</p>
<ul class="simple">
<li>All convolution and LSTM layers are layer-normalized, see
<a class="reference external" href="https://arxiv.org/abs/1607.06450">Layer Normalisation</a> paper by Jimmy Ba at al.;</li>
<li>A3C option <cite>time_flat</cite> is ON by default, improves training stability, reduces computation costs, see
<a class="reference external" href="https://kismuz.github.io/btgym/btgym.algorithms.html#module-btgym.algorithms.aac">Base_AAC class Note</a> for details;</li>
</ul>
<a class="reference internal image-reference" href="_images/a3c_stacked_lstm_agent.png"><img alt="A3C stacked LSTM agent architecture" src="_images/a3c_stacked_lstm_agent.png" style="width: 450.5px; height: 637.0px;" /></a>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="btgym.envs.html" class="btn btn-neutral float-right" title="btgym.envs package" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="BTGym DOCs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, 2018, Andrew Muzikin.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.0.7',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>